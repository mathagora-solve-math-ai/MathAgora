# PoC Report v1: LLM Step-by-Step 풀이 정렬 검증

> 실험일: 2026-02-10
> 실험자: 고운 편
> 대상 문제: 2024학년도 수능 수학(홀수) 공통 7번 (수학2, 3점)
> API: OpenRouter

---

## 실험 대상 문제

**2024학년도 수능 수학 7번**

> 함수 $f(x)=\dfrac{1}{3}x^3-2x^2-12x+4$가 $x=\alpha$에서 극대이고 $x=\beta$에서 극소일 때, $\beta-\alpha$의 값은?
>
> ① -4 ② -1 ③ 2 ④ 5 ⑤ **8** (정답)

---

## Task 1. 프롬프트 버전별 Step 구조화 품질

3가지 프롬프트로 동일 문제를 GPT-4o (temperature=0.3)에게 풀게 한 뒤, 응답에서 step을 추출하여 구조화 품질을 비교한다.

### 프롬프트 설계

| 버전 | 프롬프트 핵심 지시 |
|------|--------------------|
| v1_simple | "다음 수학 문제를 풀어주세요." |
| v2_step | "다음 수학 문제를 **단계별(step-by-step)**로 풀어주세요." |
| v3_titled | "단계별로 풀되, 각 단계마다 **간결한 제목**을 붙여주세요." + `[STEP title="..."]` 출력 포맷 명시 |

### 결과

| 버전 | 추출 step 수 | 응답 시간 | 제목 품질 | 정답 |
|------|:-----------:|:---------:|----------|:----:|
| v1_simple | **15** | 27.8s | 없음 (Part 1~15로 fallback) | 8 |
| v2_step | **5** | 6.6s | 볼드 텍스트로 암묵적 제목 ("**도함수 계산:**") | 8 |
| v3_titled | **4 + Final Answer** | 5.8s | 명시적 한국어 제목 ("극대 및 극소 조건", "도함수의 근 찾기" 등) | 8 |

### v1_simple 추출 결과

파싱 방식: paragraph 분리 (줄바꿈 2개 기준) → 구조 불량

```
Part 1:  주어진 함수의 극대와 극소를 찾기 위해, 먼저 도함수를 구합니다.
Part 2:  f'(x) = x^2 - 4x - 12
Part 3:  극대와 극소는 도함수가 0이 되는 지점에서 발생합니다.
Part 4:  x^2 - 4x - 12 = 0
Part 5:  이차 방정식을 인수분해하거나 근의 공식을 사용하여 풉니다.
...
Part 15: 따라서, β-α의 값은 8입니다. 정답은 8입니다.
```

- 수식 블록 하나가 별도 paragraph로 잡혀 step이 과도하게 분할됨
- 제목 없이 본문만 존재하여 의미적 단계 파악 불가

### v2_step 추출 결과

파싱 방식: `1.`, `2.` 등 번호 매기기 패턴 인식

```
Step 1: 도함수 계산
Step 2: 극대와 극소 찾기
Step 3: 방정식 풀기
Step 4: 극대와 극소 구분
Step 5: β - α 계산
```

- 번호 패턴으로 5개 step이 정확히 분리됨
- 제목은 볼드 텍스트에서 heuristic으로 추출해야 함 (안정성 떨어짐)

### v3_titled 추출 결과

파싱 방식: `[STEP title="..."]` 마커 기반 정규식 파싱

```
[1] 극대 및 극소 조건:    도함수 f'(x)를 구하고, f'(x)=0을 풂
[2] 도함수의 근 찾기:     이차방정식 인수분해 → x=6 또는 x=-2
[3] 극대 및 극소 구분:    도함수 부호 변화로 극대/극소 판별
[4] 극대와 극소의 차이 계산: β-α = 6-(-2) = 8
[FINAL_ANSWER] 8
```

- 마커 기반으로 정확하게 파싱됨
- 제목이 간결하고 의미적으로 명확함
- 응답 시간도 가장 짧음

### Task 1 결론

> **v3_titled 프롬프트가 step 구조화에 최적이다.**
> - 명시적 출력 포맷 지정 시 LLM이 안정적으로 구조화된 응답을 생성함
> - 파싱이 정규식 기반으로 확정적(deterministic)이며, heuristic 의존도가 없음
> - v2_step도 실용적이지만, 제목 추출이 불안정하고 모델마다 포맷이 달라질 수 있음

---

## Task 2. 코사인 유사도 기반 Step 정렬 검증

v3_titled 프롬프트로 3개 모델(GPT-4o, Claude Sonnet 4, Gemini 2.5 Flash)의 풀이를 받고, step 간 TF-IDF 코사인 유사도로 유사한 풀이 단계끼리 자동 정렬(alignment)되는지 검증한다.

### 실험 설정

- 프롬프트: v3_titled
- temperature: 0.3
- 유사도: char n-gram (2~4) TF-IDF 코사인 유사도
- alignment threshold: 0.3
- 그룹핑: Union-Find (서로 다른 모델의 step만 연결)

### 모델별 추출된 Step

| # | GPT-4o | Claude Sonnet 4 | Gemini 2.5 Flash |
|:-:|--------|-----------------|------------------|
| 1 | 미분하여 극값 찾기 | 1차 도함수 구하기 | 함수 미분 |
| 2 | 극점 찾기 | 극값 조건 적용 | 미분값이 0이 되는 x값 찾기 |
| 3 | 극대와 극소 구분 | 이차방정식 인수분해 | 이차방정식 인수분해 |
| 4 | 극점 간 거리 계산 | 2차 도함수로 극값 판별 | 극대/극소 판별 |
| 5 | Final Answer | β - α 계산 | β-α 계산 |
| 6 | - | Final Answer | Final Answer |

### 발견된 Alignment Group (5개)

| Group | 포함 모델 | 매칭된 Step | 대표 유사도 |
|:-----:|:---------:|------------|:----------:|
| **G1** | 3/3 | GPT "미분하여 극값 찾기" ↔ Claude "1차 도함수 구하기" ↔ Gemini "함수 미분" | 0.48 ~ 0.61 |
| **G2** | 3/3 | GPT "극대와 극소 구분" ↔ Claude "2차 도함수로 극값 판별" ↔ Gemini "극대/극소 판별" | 0.35 ~ 0.53 |
| **G3** | 3/3 | GPT "극점 간 거리 계산" ↔ Claude "β - α 계산" ↔ Gemini "β-α 계산" | 0.57 ~ 0.65 |
| **G4** | 3/3 | GPT "Final Answer" ↔ Claude "Final Answer" ↔ Gemini "Final Answer" | 0.93 ~ 1.00 |
| **G5** | 2/3 | Claude "이차방정식 인수분해" ↔ Gemini "이차방정식 인수분해" | 0.55 |

### 주요 Cross-solution 유사도 (상위)

| 유사도 | Model A - Step | Model B - Step |
|:------:|----------------|----------------|
| 1.000 | GPT "Final Answer" | Gemini "Final Answer" |
| 0.934 | GPT "Final Answer" | Claude "Final Answer" |
| 0.654 | Claude "β - α 계산" | Gemini "β-α 계산" |
| 0.634 | GPT "극점 간 거리 계산" | Claude "β - α 계산" |
| 0.609 | GPT "미분하여 극값 찾기" | Claude "1차 도함수 구하기" |
| 0.567 | GPT "극점 간 거리 계산" | Gemini "β-α 계산" |
| 0.551 | Claude "이차방정식 인수분해" | Gemini "이차방정식 인수분해" |
| 0.542 | Claude "1차 도함수 구하기" | Gemini "함수 미분" |
| 0.532 | Claude "2차 도함수로 극값 판별" | Gemini "극대/극소 판별" |
| 0.479 | GPT "미분하여 극값 찾기" | Gemini "함수 미분" |

### Task 2 결론

> **char n-gram TF-IDF 코사인 유사도로 유사한 풀이 단계가 정확하게 연결된다.**
> - 3개 모델 모두 동일한 풀이 흐름(미분 → 근 찾기 → 판별 → 계산)을 따르며, 유사 단계가 5개 그룹으로 잘 클러스터링됨
> - G1~G4는 3개 모델 모두 참여, G5는 동일 제목("이차방정식 인수분해")을 사용한 2개 모델만 참여
> - threshold 0.3이 적절한 수준 — false positive 없이 의미적으로 유사한 step만 묶임
> - GPT-4o의 "극점 찾기"(Step 2)는 다른 모델의 어떤 step과도 강하게 매칭되지 않음 (미분+조건 설정이 합쳐진 step)

---

## Task 3. 단일 모델 다양성 검증

**동일 모델(GPT-4o)**에 **temperature=1.0**으로 **5회** 반복 추론하여, 풀이의 다양성을 확인한다.

### 실험 설정

- 모델: GPT-4o (openai/gpt-4o)
- 프롬프트: v3_titled
- temperature: 1.0
- 반복 횟수: 5

### Run별 추출된 Step 제목

| Run | Step 수 | Step 제목 목록 |
|:---:|:-------:|---------------|
| 1 | 5 | 극점 찾기 → 이차 방정식 해 구하기 → 극점 판별 → 차이 계산 → Final Answer |
| 2 | 8 | 일차 도함수 구하기 → 극값 찾기 위한 근 구하기 → 근의 공식 적용 → 근 값 찾기 → 극대 및 극소 확인 → α, β 결정 → β-α 계산하기 → Final Answer |
| 3 | 4 | 함수의 도함수 구하기 → 도함수의 근 찾기 → 극값의 성격 판별 → Final Answer |
| 4 | 9 | 극값의 조건 → 도함수 계산 → 극점 찾기 → 인수분해 → 해 구하기 → 극대, 극소 판별 → 이차 도함수 계산 → 결과 비교 → Final Answer |
| 5 | 6 | 미분하여 도함수 찾기 → 임계점 찾기 → 이차 방정식 풀이 → 극대와 극소 판별 → 결과 계산 → Final Answer |

### Pairwise 풀이 유사도 (전체 풀이 텍스트 기준)

| | Run 1 | Run 2 | Run 3 | Run 4 | Run 5 |
|-------|:-----:|:-----:|:-----:|:-----:|:-----:|
| Run 1 | - | 0.886 | 0.887 | 0.798 | 0.742 |
| Run 2 | | - | 0.879 | 0.765 | 0.694 |
| Run 3 | | | - | 0.811 | 0.736 |
| Run 4 | | | | - | 0.825 |
| Run 5 | | | | | - |

**평균 pairwise 유사도: 0.802**

### Task 3 결론

> **동일 모델 + temperature=1.0으로는 풀이 다양성이 제한적이다.**
> - 평균 유사도 0.802로 매우 높음 — 풀이 전략(미분 → 이차방정식 → 판별 → 계산)이 5회 모두 동일
> - Step 수만 4~9개로 편차가 있을 뿐, 접근법 자체는 변하지 않음
> - 표현의 세분화 정도(한 step으로 합치냐 vs 여러 step으로 쪼개냐)만 달라짐
> - **다양한 풀이 방법론 제공이라는 시스템 목표에는 부족함**

---

## Task 4. 다중 모델 다양성 검증

**5개 서로 다른 모델**로 동일 문제를 풀어, 모델 간 풀이 다양성을 확인한다.

### 실험 설정

- 프롬프트: v3_titled
- temperature: 0.7
- 모델 5종:

| 약칭 | OpenRouter 모델 ID |
|------|-------------------|
| GPT-4o | openai/gpt-4o |
| Claude Sonnet 4 | anthropic/claude-sonnet-4 |
| Gemini 2.5 Flash | google/gemini-2.5-flash |
| Llama 4 Maverick | meta-llama/llama-4-maverick |
| Qwen 3 235B | qwen/qwen3-235b-a22b |

### 모델별 추출된 Step 제목

| # | GPT-4o | Claude Sonnet 4 | Gemini 2.5 Flash | Llama 4 Maverick | Qwen 3 235B |
|:-:|--------|-----------------|------------------|------------------|-------------|
| 1 | 1차 미분 계산 | 1차 도함수 구하기 | 함수 미분 | 도함수 구하기 | 도함수 구하기 |
| 2 | 극값 조건 찾기 | 극값 조건 적용 | 도함수가 0이 되는 x값 찾기 | 극값 조건 적용 | 임계점 계산 |
| 3 | 근의 공식 사용 | 1차 도함수의 해 구하기 | 인수분해 | 이차방정식의 근 구하기 | 2차 도함수로 극값 판정 |
| 4 | 극대 및 극소 판별 | 2차 도함수로 극값 판별 | 극대/극소 판별 | α, β 결정 | 결과 계산 |
| 5 | 극대와 극소 좌표 값 찾기 | α, β 값 확정 | β-α 계산 | β-α 계산 | Final Answer |
| 6 | 결과 계산 | β - α 계산 | Final Answer | Final Answer | - |
| 7 | Final Answer | Final Answer | - | - | - |

### Pairwise 풀이 유사도

| | GPT-4o | Claude | Gemini | Llama | Qwen |
|------|:------:|:------:|:------:|:-----:|:----:|
| GPT-4o | - | 0.399 | 0.314 | 0.468 | 0.379 |
| Claude | | - | 0.586 | 0.659 | 0.606 |
| Gemini | | | - | 0.561 | 0.485 |
| Llama | | | | - | 0.535 |
| Qwen | | | | | - |

**평균 pairwise 유사도: 0.499**

### 발견된 Alignment Group (5개)

| Group | 포함 모델 수 | 매칭 내용 |
|:-----:|:----------:|----------|
| G1 | 5/5 | 미분/도함수 구하기 단계 (GPT, Claude, Gemini, Llama, Qwen 전원 참여) |
| G2 | 5/5 | 극값 판별 + 결과 계산 단계 (전원 참여, 다수 step이 합류) |
| G3 | 5/5 | Final Answer (전원) |
| G4 | 3/5 | 이차방정식 풀기 (Claude, Gemini, Qwen) |
| G5 | 2/5 | 극값 조건 (GPT, Gemini) |

### Task 4 결론

> **서로 다른 모델을 사용하는 것이 temperature 조절보다 확실히 풀이 다양성을 높인다.**
> - 평균 유사도 0.499 — Task 3의 0.802 대비 **약 37% 낮음**
> - GPT-4o가 다른 모델들과 가장 다름 (0.31~0.47) — 근의 공식을 명시적으로 사용하는 등 표현 차이
> - Claude/Llama/Qwen은 서로 비교적 유사 (0.54~0.66) — 인수분해 기반 접근이 겹침
> - 그럼에도 alignment group이 의미적으로 잘 분리되어 step 연결 시각화에 충분한 다양성 제공

---

## 종합 결론 및 시사점

### 1. 프롬프트 전략

**v3_titled (명시적 마커 포맷) 사용을 권장한다.**
- 파싱 안정성, 제목 품질, 응답 속도 모두 최우수
- 향후 백엔드 구현 시 `[STEP title="..."]` / `[FINAL_ANSWER]` 포맷을 표준으로 채택 가능

### 2. Step 정렬 가능성

**char n-gram TF-IDF 코사인 유사도 + Union-Find로 cross-model step 정렬이 잘 동작한다.**
- threshold 0.3 수준에서 false positive 없이 의미적으로 유사한 step이 정확히 연결됨
- 기존 프론트엔드의 Jaccard 기반 alignment 대비, TF-IDF 코사인 유사도가 한국어+수식 혼합 텍스트에서 더 강건할 가능성 있음 (추가 비교 필요)

### 3. 다양성 확보 전략

| 전략 | 평균 유사도 | 다양성 |
|------|:----------:|:------:|
| 동일 모델, temp=1.0, 5회 | 0.802 | 낮음 |
| 서로 다른 모델 5종, temp=0.7 | 0.499 | 높음 |

**다양한 풀이 제공을 위해서는 다중 모델 사용이 필수적이다.**
동일 모델 반복은 표현만 달라질 뿐 풀이 전략 자체의 다양성은 거의 없다.

### 4. 후속 작업 제안

- [ ] 더 어려운 문제(4점 문항)에서도 동일하게 동작하는지 검증
- [ ] 풀이 전략이 실질적으로 다른 문제(예: 치환적분 vs 부분적분)에 대한 다양성 검증
- [ ] 임베딩 기반 유사도(sentence-transformers 등)와 TF-IDF 비교
- [ ] 프론트엔드 시각화에 연결선(edge) 렌더링 PoC
- [ ] 실시간 스트리밍 중 부분적 alignment 가능성 검토
